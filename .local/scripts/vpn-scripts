#!/bin/bash
set -euo pipefail

STATE_FILE="/tmp/vpn-scripts-state"

set_state() {
  echo "$1" > "$STATE_FILE"
}

get_state() {
  if [[ -f "$STATE_FILE" ]]; then
    cat "$STATE_FILE"
  else
    echo "disconnected"
  fi
}

vpn_connect() {
    local code2fa="2457$(2fa 'mgc')"
    osascript -e 'tell application "System Events" to tell process "OpenVPN Connect" to tell menu bar item 1 of menu bar 2' \
    -e 'click' \
    -e 'get menu items of menu 1' \
    -e '
      try
        click menu item "Connect" of menu 1
        do shell script "echo OpenVPN ready to connect"
      on error
        key code 53
        do shell script "echo Already connected"
      end try' \
    -e "
  delay 0.5
  set textBuffer to \"$code2fa\"
  repeat with i from 1 to count characters of textBuffer
    keystroke (character i of textBuffer)
    delay 0.05
  end repeat"\
    -e 'keystroke return'\
   -e 'end tell'
  # -e 'tell application "System Events" to keystroke "w" using command down'\
  if [[ $? -eq 0 ]]; then
    set_state "connected"
  fi
}

vpn_disconnect() {
    osascript -e 'tell application "System Events" to tell process "OpenVPN Connect" to tell menu bar item 1 of menu bar 2' \
      -e 'click' \
      -e 'get menu items of menu 1' \
      -e '
    try
    click menu item "Disconnect" of menu 1
    on error
    key code 53
  end try' \
    -e 'end tell'

  if [[ $? -eq 0 ]]; then
    set_state "disconnected"
  fi
}

show_usage() {
    echo "Usage: $0 [-c|-x|-s]"
    echo "  -c  Connect to VPN"
    echo "  -x  Disconnect from VPN"
    echo "  -s  Check VPN status (instant)"
    exit 1
}

# Main execution
case "${1:-}" in
  -c)
    vpn_connect
    ;;
  -x)
    vpn_disconnect
    ;;
  -s)
    get_state
    ;;
  *)
    show_usage
    ;;
esac
